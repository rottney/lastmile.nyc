<!DOCTYPE html>
<html>
  <head>
    <title>lastmile.nyc</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link rel="shortcut icon" href="images/favicon.png">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin="">
    </script>

    <link rel="stylesheet" href="css/TripgoRouting.css"/>

    <script src="lib/Polyline.encoded.js"></script>
    <script src="lib/jquery-3.2.1.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/@geoapify/leaflet-address-search-plugin@^1/dist/L.Control.GeoapifyAddressSearch.min.css" />
    <script src="https://unpkg.com/@geoapify/leaflet-address-search-plugin@^1/dist/L.Control.GeoapifyAddressSearch.min.js"></script>

  </head>
  <body>
    <div id="map"></div>

    <script type="module">
        import { tripgoRouting } from "./src/TripGoRouting.js"
        import { mapLayer } from "./src/MapLayer.js";
        import { routeService } from "./src/RouteService.js";
        import { util } from "./src/Util.js";
        import { tripWidget } from "./src/TripWidget.js";

        // center of nyc
        const lat = 40.6971041913;
        const lng = -73.9795382135;

        // Tripgo initialization
        let tripgoOptions = {
            "mapId" : "map",
            "mapCenter" : {
                "lat": lat,
                "lng": lng,
            },
            "floatPanel": true,
            "tripgoApiKey": "9f9623a674f4307a10083542fc91748d", // HIDE ME
        };

        L.tripgoRouting.mapLayer = mapLayer;
        L.tripgoRouting.mapLayer.initialize(tripgoOptions);
        const map = L.tripgoRouting.mapLayer.getMap();

        L.tripgoRouting.routeService = routeService;
        L.tripgoRouting.util = util;
        L.tripgoRouting.tripWidget = tripWidget;

        // Geoapify initialization
        const geoapifyKey = "b054a9def22d4a9cb953354cf062f058"; // HIDE ME

        const origin = L.control.addressSearch(geoapifyKey, {
          position: "topleft",
          placeholder: "Origin",
          resultCallback: (address) => {
            const lat = address.lat;
            const lng = address.lon;
            mapLayer.createMarker("from", lat, lng);
          },
        });
        map.addControl(origin);

        const destination = L.control.addressSearch(geoapifyKey, {
          position: "topleft",
          placeholder: "Destination",
          resultCallback: (address) => {
            const lat = address.lat;
            const lng = address.lon;
            mapLayer.createMarker("to", lat, lng);
          },
        });
        map.addControl(destination);

        // Custom code

        // Add settings form
        L.Control.Settings = L.Control.extend({
          onAdd: function(map) {
            const p = L.DomUtil.create("div");
            const form = `
              <form 
                action="http://localhost:5000/setmodes" 
                method="post" 
                target="_blank" 
                style="background-color: coral; padding: 12px;"
              >
                <input type="checkbox" id="transitbox" name="transit" value="pt_pub">
                <label for="transitbox"> Show transit directions</label><br>
                <input type="checkbox" id="bikesharebox" name="bikeshare" value="me_mic-s">
                <label for="bikesharebox"> Show bikeshare directions</label><br>
                <input type="checkbox" id="walkingbox" name="walking" value="wa_wal">
                <label for="walkingbox"> Show walking directions</label><br>
                <input type="checkbox" id="ridesharebox" name="rideshare" value="ps_tax ps_tnc">
                <label for="ridesharebox"> Show rideshare directions</label><br>
                <input type="submit" value="Submit">
              </form>
            `;
            p.innerHTML = form;
            return p;
          },

          onRemove: function(map) {
            // nothing to do here
          }
        });

        L.control.settings = function(opts) {
          return new L.Control.Settings(opts);
        }

        L.control.settings({ position: "topright" }).addTo(map);

        // Sync form state with settings database
        function setSettings(settings) {
            const transitbox = document.getElementById("transitbox");
            const bikesharebox = document.getElementById("bikesharebox");
            const walkingbox = document.getElementById("walkingbox");
            const ridesharebox = document.getElementById("ridesharebox");

            transitbox.checked = settings.includes("pt_pub");
            bikesharebox.checked = settings.includes("me_mic-s");
            walkingbox.checked = settings.includes("wa_wal");
            ridesharebox.checked = settings.includes("ps_tax") && settings.includes("ps_tnc");
        }

        fetch("http://localhost:5000/getmodes")
            .then((response) => response.json())
            .then((json) => setSettings(json));
    </script>
  </body>
</html>
